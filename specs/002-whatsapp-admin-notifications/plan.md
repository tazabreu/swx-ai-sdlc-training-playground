# Implementation Plan: WhatsApp Admin Notifications

**Branch**: `002-whatsapp-admin-notifications` | **Date**: 2026-01-04 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-whatsapp-admin-notifications/spec.md`

## Summary

Integrate WhatsApp notifications for admin approval workflows using the deployed wpp-connect server. When low-score users request cards, admins receive WhatsApp messages and can reply with "y {ID}" or "n {ID}" to approve/reject. Payment notifications are sent as informational alerts.

**Technical Approach**: Event-driven architecture using the existing outbox pattern. A new WhatsApp client communicates with wpp-connect server at `35.232.155.23:21465`. Webhook endpoint receives admin replies and triggers existing approval handlers.

## Technical Context

**Language/Version**: TypeScript 5.x
**Package Manager**: Bun (required per constitution)
**Primary Dependencies**: Express, Firebase Admin SDK, uuid, existing DI container
**Storage**: Firestore (existing) + 3 new collections for WhatsApp state
**Testing**: Bun test (existing Jest-compatible runner)
**Target Platform**: Firebase Functions on GKE
**Project Type**: Single project (existing structure)
**Performance Goals**: Notifications within 30 seconds, webhook response <5 seconds
**Constraints**: Shared secret auth (IP allowlist deferred for sandbox)
**Scale/Scope**: 2 admin phones, ~10-100 requests/day initially

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

- [x] Uses Bun for install/scripts (`bun install`, `bun run <script>`)
- [x] Backend is TypeScript + Express on Firebase Functions
- [x] Frontend: N/A (API-only feature)
- [x] Event publishing uses transactional outbox to Redpanda/Kafka (existing pattern extended)

**Notes**: No constitution violations. Feature extends existing patterns.

## Project Structure

### Documentation (this feature)

```text
specs/002-whatsapp-admin-notifications/
├── plan.md              # This file
├── research.md          # WPP-Connect and codebase research
├── data-model.md        # Entity definitions
├── quickstart.md        # Development setup guide
├── contracts/
│   ├── whatsapp-webhook.openapi.yaml    # Incoming webhook API
│   └── wpp-connect-client.openapi.yaml  # Outgoing WPP-Connect calls
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
src/
├── api/
│   ├── routes/
│   │   ├── admin.ts              # Existing admin routes
│   │   └── webhooks.ts           # NEW: WhatsApp webhook endpoint
│   └── middleware/
│       └── webhook-auth.ts       # NEW: X-Webhook-Secret validation
├── application/
│   └── handlers/
│       ├── admin-approve-card.handler.ts    # Existing (reused)
│       ├── admin-reject-card.handler.ts     # Existing (reused)
│       └── whatsapp-approval.handler.ts     # NEW: Parse & route webhook
├── domain/
│   ├── entities/
│   │   ├── whatsapp-notification.entity.ts  # NEW
│   │   ├── whatsapp-inbound.entity.ts       # NEW
│   │   └── pending-approval.entity.ts       # NEW
│   ├── services/
│   │   ├── notification.service.ts          # NEW: Send notifications
│   │   └── message-parser.service.ts        # NEW: Parse y/n commands
│   └── events/
│       └── types.ts              # Extended with WhatsApp events
├── infrastructure/
│   ├── whatsapp/
│   │   ├── client.ts             # NEW: WPP-Connect HTTP client
│   │   ├── types.ts              # NEW: WPP-Connect types
│   │   └── phone-utils.ts        # NEW: Brazilian phone normalization
│   ├── persistence/
│   │   ├── interfaces/
│   │   │   ├── whatsapp-notification.repository.ts  # NEW
│   │   │   ├── whatsapp-inbound.repository.ts       # NEW
│   │   │   └── pending-approval.repository.ts       # NEW
│   │   └── firestore/
│   │       ├── whatsapp-notification.firestore.ts   # NEW
│   │       ├── whatsapp-inbound.firestore.ts        # NEW
│   │       └── pending-approval.firestore.ts        # NEW
│   └── di/
│       └── container.ts          # Extended with new services

tests/
├── unit/
│   ├── infrastructure/
│   │   └── whatsapp/
│   │       ├── client.test.ts
│   │       └── phone-utils.test.ts
│   ├── domain/
│   │   └── services/
│   │       ├── notification.service.test.ts
│   │       └── message-parser.service.test.ts
│   └── application/
│       └── handlers/
│           └── whatsapp-approval.handler.test.ts
├── contract/
│   └── webhooks.test.ts          # NEW
└── integration/
    └── whatsapp/
        └── notification-flow.test.ts  # NEW
```

**Structure Decision**: Single project structure maintained. WhatsApp-specific code in dedicated subdirectories under existing structure.

## Complexity Tracking

> No constitution violations requiring justification.

| Area | Complexity | Justification |
|------|------------|---------------|
| 3 new entities | Low | Simple tracking state, follows existing patterns |
| WPP-Connect client | Medium | External HTTP integration, token caching |
| Webhook handler | Low | Standard Express route + parsing logic |
| Event subscription | Low | Extends existing outbox pattern |

---

## Phase 0: Research (Complete)

See [research.md](./research.md) for detailed findings.

### Key Decisions

| Unknown | Resolution |
|---------|------------|
| WPP-Connect server location | `35.232.155.23:21465` with secret key in tfstate |
| Webhook payload format | Standard wpp-connect format with `event`, `session`, `data` |
| Admin handler integration | Reuse existing `handleAdminApproveCard` and `handleAdminRejectCard` |
| Phone format | Brazilian E.164 (13 digits): `55` + DDD + `9` + subscriber |
| Message correlation | Request ID in message body, admin replies "y 12345" |

---

## Phase 1: Design (Complete)

### Data Model

See [data-model.md](./data-model.md) for full entity definitions.

**New Entities**:
- `WhatsAppNotification`: Outbound message tracking with retry state
- `WhatsAppInboundMessage`: Inbound message with parsed commands
- `PendingApprovalTracker`: Links requests to notifications

**New Collections**: `whatsapp_notifications`, `whatsapp_inbound`, `pending_approvals`

### API Contracts

See [contracts/](./contracts/) directory.

- `whatsapp-webhook.openapi.yaml`: Webhook endpoint for admin replies
- `wpp-connect-client.openapi.yaml`: WPP-Connect API client contract

### Integration Points

1. **Card Request Created (low-score)** → Send approval notification to admins
2. **Payment Completed** → Send informational notification to admins
3. **Webhook Received** → Parse command → Call admin approve/reject handler

---

## Implementation Phases

### Phase 2: Core Infrastructure

1. **WhatsApp Client** (`src/infrastructure/whatsapp/client.ts`)
   - Token generation and caching
   - Send message with retry
   - Session health check

2. **Phone Utilities** (`src/infrastructure/whatsapp/phone-utils.ts`)
   - Brazilian E.164 normalization
   - Whitelist validation

3. **New Entities** (`src/domain/entities/`)
   - WhatsAppNotification entity with factory
   - WhatsAppInboundMessage entity with parser
   - PendingApprovalTracker entity

4. **Repositories** (`src/infrastructure/persistence/`)
   - Firestore implementations for 3 new collections
   - Query methods for pending/retry queues

### Phase 3: Application Layer

5. **Message Parser Service** (`src/domain/services/message-parser.service.ts`)
   - Parse "y/yes {ID}" and "n/no {ID}" patterns
   - Case-insensitive matching
   - Extract request ID

6. **Notification Service** (`src/domain/services/notification.service.ts`)
   - Format card request notification message
   - Format payment notification message
   - Send to both admin phones

7. **WhatsApp Approval Handler** (`src/application/handlers/whatsapp-approval.handler.ts`)
   - Validate sender is whitelisted admin
   - Parse command and find request
   - Delegate to existing admin handlers
   - Update tracking state

### Phase 4: API Layer

8. **Webhook Auth Middleware** (`src/api/middleware/webhook-auth.ts`)
   - Validate X-Webhook-Secret header

9. **Webhook Route** (`src/api/routes/webhooks.ts`)
   - POST /webhooks/wpp-connect
   - Health check endpoint

10. **DI Container Updates** (`src/infrastructure/di/container.ts`)
    - Register new services and repositories
    - Add WhatsApp client as singleton

### Phase 5: Event Integration

11. **Event Handlers** (extend existing)
    - On `card.requested` (low-score): Send approval notification
    - On `transaction.payment`: Send payment notification

12. **Outbox Processing** (extend existing)
    - Mark WhatsApp-related events as processed after notification sent

### Phase 6: Testing

13. **Unit Tests**
    - Phone normalization
    - Message parsing
    - Notification formatting
    - Handler logic with mocks

14. **Contract Tests**
    - Webhook endpoint responses
    - Auth validation

15. **Integration Tests**
    - Full approval flow with mocked wpp-connect

---

## Environment Variables Summary

```bash
# Required
WPP_BASE_URL=http://35.232.155.23:21465
WPP_SECRET_KEY=<from-tfstate>
WPP_SESSION_NAME=tazco-financial-api
ADMIN_PHONE_1=5573981112636
ADMIN_PHONE_2=5548998589532
WEBHOOK_SECRET=<generate-random>

# Optional
WHATSAPP_NOTIFICATIONS_ENABLED=true
```

---

## Test Requirements (per Constitution)

- [ ] All new code has corresponding unit tests
- [ ] Webhook endpoint has contract tests
- [ ] Integration test covers approval flow
- [ ] Tests pass before PR merge
- [ ] Test coverage includes error cases

---

## Next Steps

Run `/speckit.tasks` to generate implementation tasks from this plan.
