openapi: 3.0.3
info:
  title: WPP-Connect Client API
  description: |
    API contract for communicating with the wpp-connect server.
    These are the endpoints the Financial API will call to send WhatsApp messages.
  version: 1.0.0

servers:
  - url: http://35.232.155.23:21465
    description: Deployed wpp-connect server (dev)
  - url: http://localhost:21465
    description: Via SSH tunnel

paths:
  /api/{session}/{secretKey}/generate-token:
    post:
      operationId: generateToken
      summary: Generate bearer token for session
      description: |
        Generates a session-scoped bearer token using the secret key.
        This token is used for all subsequent API calls.
      tags:
        - Authentication
      parameters:
        - $ref: '#/components/parameters/SessionName'
        - name: secretKey
          in: path
          required: true
          schema:
            type: string
          description: WPP-Connect secret key
      responses:
        '200':
          description: Token generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  token:
                    type: string
                    description: Bearer token for API calls
                    example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        '401':
          description: Invalid secret key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WppError'

  /api/{session}/start-session:
    post:
      operationId: startSession
      summary: Start WhatsApp session
      description: |
        Initializes a WhatsApp session. If not already connected,
        returns QR code for scanning with WhatsApp mobile app.
      tags:
        - Session
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionName'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                webhook:
                  type: string
                  format: uri
                  description: URL to receive webhook events
                  example: "https://api.tazco.example.com/webhooks/wpp-connect"
                waitQrCode:
                  type: boolean
                  description: Wait for QR code in response
                  default: true
      responses:
        '200':
          description: Session started
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [CONNECTED, QRCODE, INITIALIZING]
                  qrcode:
                    type: string
                    description: Base64-encoded QR code image
                  urlcode:
                    type: string
                    description: QR code content for terminal rendering

  /api/{session}/send-message:
    post:
      operationId: sendMessage
      summary: Send WhatsApp message
      description: |
        Sends a text message to a phone number via WhatsApp.
        Phone number should be in E.164 format without '+' sign.
      tags:
        - Messaging
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionName'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessageRequest'
            examples:
              cardRequestNotification:
                summary: Card request approval notification
                value:
                  phone: "5573981112636"
                  message: |
                    [Card Request #ABC123]
                    Customer: user@example.com
                    Tier: medium
                    Score: 550

                    Reply: "y ABC123" to approve
                    Reply: "n ABC123" to reject
              paymentNotification:
                summary: Payment notification
                value:
                  phone: "5573981112636"
                  message: |
                    [Payment Received]
                    Card: **** 1234
                    Amount: R$ 500.00
                    Time: 2026-01-04 14:30

                    (No action required)
      responses:
        '200':
          description: Message sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendMessageResponse'
        '400':
          description: Invalid phone number or message
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WppError'
        '401':
          description: Invalid or expired bearer token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WppError'
        '500':
          description: WhatsApp connection error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WppError'

  /api/{session}/check-connection-session:
    get:
      operationId: checkConnection
      summary: Check session connection status
      description: Verifies if the WhatsApp session is connected
      tags:
        - Session
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionName'
      responses:
        '200':
          description: Connection status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [CONNECTED, DISCONNECTED, INITIALIZING]
                  message:
                    type: string

  /api/{session}/check-number-status:
    post:
      operationId: checkNumberStatus
      summary: Check if phone number is on WhatsApp
      description: Validates if a phone number is registered on WhatsApp
      tags:
        - Validation
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionName'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
              properties:
                phone:
                  type: string
                  description: Phone number in E.164 format
                  example: "5573981112636"
      responses:
        '200':
          description: Number status
          content:
            application/json:
              schema:
                type: object
                properties:
                  exists:
                    type: boolean
                    description: Whether number is on WhatsApp
                  canReceiveMessage:
                    type: boolean

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: Bearer token from generate-token endpoint

  parameters:
    SessionName:
      name: session
      in: path
      required: true
      schema:
        type: string
        example: tazco-financial-api
      description: WhatsApp session name

  schemas:
    SendMessageRequest:
      type: object
      required:
        - phone
        - message
      properties:
        phone:
          type: string
          description: Recipient phone in E.164 format (no + sign)
          pattern: '^\d{10,15}$'
          example: "5573981112636"
        message:
          type: string
          description: Message text content
          maxLength: 4096
          example: "Hello from Financial API"

    SendMessageResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        id:
          type: string
          description: WPP-Connect message ID
          example: "true_5573981112636@c.us_3EB0..."
        chatId:
          type: string
          description: Chat identifier
          example: "5573981112636@c.us"

    WppError:
      type: object
      properties:
        status:
          type: string
          example: error
        message:
          type: string
          example: "Session not connected"
        error:
          type: string
          description: Error details
