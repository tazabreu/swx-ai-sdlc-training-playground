openapi: 3.0.3
info:
  title: WhatsApp Admin Notifications - Webhook API
  description: |
    Webhook endpoint for receiving WhatsApp messages from wpp-connect server.
    This endpoint processes admin approval/rejection commands.
  version: 1.0.0
  contact:
    name: Tazco Financial API

servers:
  - url: https://api.tazco.example.com
    description: Production
  - url: http://localhost:3000
    description: Local development

paths:
  /webhooks/wpp-connect:
    post:
      operationId: receiveWhatsAppMessage
      summary: Receive WhatsApp message from wpp-connect
      description: |
        Receives incoming WhatsApp messages forwarded by the wpp-connect server.
        Parses admin approval/rejection commands in format: "y {requestId}" or "n {requestId}".
      tags:
        - Webhooks
      security:
        - WebhookSecret: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WppConnectWebhookPayload'
            examples:
              approvalMessage:
                summary: Admin approves a card request
                value:
                  event: onMessage
                  session: tazco-financial-api
                  data:
                    from: "5573981112636@c.us"
                    body: "y 12345678"
                    fromMe: false
                    isGroupMsg: false
              rejectionMessage:
                summary: Admin rejects a card request
                value:
                  event: onMessage
                  session: tazco-financial-api
                  data:
                    from: "5548998589532@c.us"
                    body: "no 12345678"
                    fromMe: false
                    isGroupMsg: false
              unknownMessage:
                summary: Unrecognized message (ignored)
                value:
                  event: onMessage
                  session: tazco-financial-api
                  data:
                    from: "5573981112636@c.us"
                    body: "What's my balance?"
                    fromMe: false
                    isGroupMsg: false
      responses:
        '200':
          description: Message received and processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'
              examples:
                processed:
                  value:
                    ok: true
                    action: approved
                    requestId: "12345678"
                ignored:
                  value:
                    ok: true
                    action: ignored
                    reason: not_whitelisted
        '400':
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: INVALID_PAYLOAD
                  message: Missing required field 'data.from'
        '401':
          description: Invalid or missing webhook secret
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: UNAUTHORIZED
                  message: Invalid webhook secret
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /webhooks/wpp-connect/health:
    get:
      operationId: webhookHealthCheck
      summary: Webhook endpoint health check
      description: Returns health status of the webhook endpoint
      tags:
        - Webhooks
      responses:
        '200':
          description: Healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true
                  timestamp:
                    type: string
                    format: date-time

components:
  securitySchemes:
    WebhookSecret:
      type: apiKey
      in: header
      name: X-Webhook-Secret
      description: Shared secret for webhook authentication

  schemas:
    WppConnectWebhookPayload:
      type: object
      required:
        - event
        - session
        - data
      properties:
        event:
          type: string
          description: Event type from wpp-connect
          enum:
            - onMessage
            - onAck
            - onStateChange
          example: onMessage
        session:
          type: string
          description: WhatsApp session name
          example: tazco-financial-api
        data:
          $ref: '#/components/schemas/MessageData'

    MessageData:
      type: object
      required:
        - from
        - body
      properties:
        from:
          type: string
          description: Sender phone in wpp-connect format (e.g., "5573981112636@c.us")
          pattern: '^\d+@(c|g)\.us$'
          example: "5573981112636@c.us"
        body:
          type: string
          description: Message text content
          maxLength: 4096
          example: "y 12345678"
        fromMe:
          type: boolean
          description: Whether message is from the bot itself
          default: false
        isGroupMsg:
          type: boolean
          description: Whether message is from a group chat
          default: false
        chatId:
          type: string
          description: Alternative field for sender (same as 'from')
        text:
          type: string
          description: Alternative field for body
        isFromMe:
          type: boolean
          description: Alternative field for fromMe

    WebhookResponse:
      type: object
      properties:
        ok:
          type: boolean
          description: Whether the request was processed successfully
        action:
          type: string
          description: Action taken
          enum:
            - approved
            - rejected
            - ignored
            - error
        requestId:
          type: string
          description: Card request ID that was processed (if applicable)
        reason:
          type: string
          description: Reason for ignoring (if action is 'ignored')
          enum:
            - not_whitelisted
            - from_self
            - group_message
            - invalid_command
            - request_not_found
            - already_processed
            - non_message_event

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              description: Error code
              example: INVALID_PAYLOAD
            message:
              type: string
              description: Human-readable error message
              example: Missing required field 'data.from'
            details:
              type: object
              description: Additional error details
